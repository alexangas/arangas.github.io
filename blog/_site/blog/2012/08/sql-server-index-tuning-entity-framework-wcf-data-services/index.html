
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>SQL Server index tuning flavoured with Entity Framework and WCF Data Services</title>
    
    <meta name="author" content="Alex Angas">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">Alex Angas</a>
          <ul class="nav">
            
            
            


  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>SQL Server index tuning flavoured with Entity Framework and WCF Data Services </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>22 August 2012</span>
    </div>
    <div class="content">
      <p>I&#8217;m working on a particularly database intensive application at the moment. We use Entity Framework code first for our back-end database reads and writes, and have a WCF Data Services wrapper for REST read access from the UI.</p>

<p>Over the last few weeks as load has increased I&#8217;ve started noticing the occasional SQL deadlock and timeout on production. Suddenly yesterday we reached some sort of tipping point and were inundated with timeouts. The cause of most of these was found just by running SQL Profiler and watching some unnecessary queries spill down the screen (multiple functions inside a view, bad idea). Once the chaos was largely over, I started looking at whether our database indexes were actually useful and how to verify this with EF and WCF DS.</p>

<h1 id="configuring-sql-profiler-for-entity-framework">Configuring SQL Profiler for Entity Framework</h1>

<p>These are the SQL Profiler settings I found worked best to capture both EF and WCF DS queries (with Show All Columns ticked):</p>

<ul>
  <li>
    <p>SP:StmtCompleted</p>
  </li>
  <li>
    <p>SP:StmtStarting</p>
  </li>
  <li>
    <p>SQL:BatchCompleted</p>
  </li>
  <li>
    <p>SQL:BatchStarting</p>
  </li>
</ul>

<p>This combination allows you to see CPU time and how long statements took, as well as then letting you load the trace into Database Tuning Advisor (DTA). If you want to check for timeouts and deadlocks as well, make sure you include:</p>

<ul>
  <li>
    <p>Deadlock graph</p>
  </li>
  <li>
    <p>Lock:Deadlock</p>
  </li>
  <li>
    <p>Lock:Deadlock Chain</p>
  </li>
  <li>
    <p>Lock:Timeout (timeout &gt; 0)</p>
  </li>
</ul>

<p><img src="http://www.alexangas.com/blog/wp-content/uploads/2012/08/TraceProperties.png" alt="" /></p>

<p>Back to the Database Tuning Advisor, it specifically <a href="http://msdn.microsoft.com/en-us/library/ms190957%28v=sql.105%29">requires</a> SQL:BatchCompleted and SP:StmtCompleted. The details of how to get that running <a href="http://msdn.microsoft.com/en-us/library/ms178095%28v=sql.105%29">is on MSDN</a>. Set the SQL Profiler trace to output to a file (if you want to analyse on your local machine) or database table. Let it run for a few hours while the tasks you want to optimise are being performed by your users. If you&#8217;re game you can run this on production for more accurate results, but a test environment is preferred provided you can recreate a typical load.</p>

<h1 id="analyzing-sql-profiler-results-in-the-database-tuning-advisor">Analyzing SQL Profiler results in the Database Tuning Advisor</h1>

<p>I found the most useful things from the DTA are the SQL script of recommendations in combination with the &#8220;Index usage report (recommended)&#8221;. These will get you 90% of the way to some quick optimizations. After running the DTA, save the SQL script from the Actions / Save Recommendations menu. Then switch over to the Reports tab, choose the report just mentioned, and then right-click on the table of results and click &#8220;Export To File&#8221; (this feature is not obvious!).</p>

<p>Copy both files over to your local machine. Open the script in a text editor, and use Excel to open the XML report. Sort by &#8220;PercentUsage&#8221; and look at how the indexes you already have compare with the DTA recommendations (that start with _dta_index). You can easily find its recommended indexes in the SQL script and adapt them to your needs - just give them good names! Also consider dropping the indexes that don&#8217;t show up at all as each database write usually causes an update of the index which can take time and cause further timeout issues.</p>


    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#.net-ref">
    		.net <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#database-ref">
    		database <span>1</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#database-ref">database <span>1</span></a></li>
     
    	<li><a href="/tags.html#entity-framework-ref">entity-framework <span>1</span></a></li>
     
    	<li><a href="/tags.html#performance-ref">performance <span>1</span></a></li>
     
    	<li><a href="/tags.html#wcf-data-services-ref">wcf-data-services <span>1</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/blog/2011/12/jekyll-introduction" title="Jekyll Introduction">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next disabled"><a>Next &rarr;</a>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_shortname = 'arangas'; // required: replace example with your forum shortname
    var disqus_identifier = '362 http://alexangas.github.io/?p=362';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2013 Alex Angas
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-9771527-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



  </body>
</html>

